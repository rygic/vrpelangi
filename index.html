<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PELANGI - VR Experience Sidoarjo</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        #header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.8);
            text-align: center;
            z-index: 100;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #fdbb2d;
            margin-bottom: 0.5rem;
        }
        
        #vr-container {
            width: 100%;
            height: 100vh;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 100;
        }
        
        .control-btn {
            padding: 10px 15px;
            background: #fdbb2d;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1rem;
            color: #fdbb2d;
        }
        
        #debug {
            position: fixed;
            top: 80px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            max-width: 300px;
        }
        
        #youtube-player {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="logo">PELANGI</div>
        <div class="loading-text" id="status-text">Memulai pengalaman VR...</div>
        <button class="control-btn" onclick="forcePlay()" style="margin-top: 20px;">Klik jika video tidak muncul</button>
    </div>

    <!-- Debug Info -->
    <div id="debug"></div>

    <!-- Header -->
    <div id="header">
        <div class="logo">PELANGI</div>
        <div>Legends & Origins of Sidoarjo - VR Experience</div>
    </div>

    <!-- A-Frame Scene -->
    <a-scene 
        vr-mode-ui="enabled: true" 
        xr-mode-ui="enabled: true" 
        renderer="colorManagement: true; antialias: true"
        background="color: #000000">
        
        <!-- Assets -->
        <a-assets>
            <video id="video360" crossorigin="anonymous" loop playsinline webkit-playsinline>
                <!-- Video akan dimuat via JavaScript -->
            </video>
        </a-assets>

        <!-- Video Sphere -->
        <a-videosphere 
            id="videosphere"
            src="#video360"
            rotation="0 -90 0">
        </a-videosphere>

        <!-- Camera -->
        <a-entity camera look-controls wasd-controls position="0 0 0">
            <a-cursor fuse="true" fuse-timeout="2000"></a-cursor>
        </a-entity>
    </a-scene>

    <!-- Controls -->
    <div id="controls" style="display: none;">
        <button class="control-btn" onclick="togglePlay()">‚èØÔ∏è Play/Pause</button>
        <button class="control-btn" onclick="enterVR()">üëì VR Mode</button>
        <button class="control-btn" onclick="toggleMute()">üîá Mute</button>
    </div>

    <!-- YouTube Player (Hidden) -->
    <div id="youtube-player"></div>

    <script>
        let player;
        let videoElement;
        let isPlaying = false;
        const videoId = 'nV_hd6bLXmw';

        // Debug logging
        function debugLog(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status-text').textContent = message;
            debugLog(message);
        }

        // Force play function
        function forcePlay() {
            updateStatus("Memaksa pemutaran video...");
            if (videoElement) {
                videoElement.play().catch(e => {
                    debugLog("Error force play: " + e.message);
                });
            }
            if (player && player.playVideo) {
                player.playVideo();
            }
        }

        // Initialize when page loads
        window.onload = function() {
            updateStatus("Halaman dimuat, inisialisasi YouTube API...");
            
            // Load YouTube API
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        };

        // YouTube API callback
        function onYouTubeIframeAPIReady() {
            updateStatus("YouTube API Ready, membuat player...");
            
            player = new YT.Player('youtube-player', {
                width: '1280',
                height: '720',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'rel': 0,
                    'modestbranding': 1,
                    'enablejsapi': 1,
                    'autoplay': 0, // Jangan autoplay dulu
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            updateStatus("YouTube Player Ready");
            debugLog("Player duration: " + player.getDuration());
            
            // Dapatkan video element dari YouTube player
            setTimeout(() => {
                videoElement = document.querySelector('#youtube-player video');
                if (videoElement) {
                    setupVideoElement(videoElement);
                } else {
                    updateStatus("Video element tidak ditemukan, mencoba lagi...");
                    setTimeout(() => {
                        videoElement = document.querySelector('#youtube-player video');
                        if (videoElement) setupVideoElement(videoElement);
                    }, 1000);
                }
            }, 1000);
        }

        function setupVideoElement(video) {
            updateStatus("Mengatur video element...");
            
            // Set properti video
            video.setAttribute('crossorigin', 'anonymous');
            video.setAttribute('playsinline', 'true');
            video.setAttribute('webkit-playsinline', 'true');
            video.setAttribute('muted', 'true'); // Mute dulu untuk bypass autoplay
            video.loop = true;
            
            debugLog("Video properties set: " + video.readyState);
            
            // Setup A-Frame video texture
            setupAFrameVideo(video);
        }

        function setupAFrameVideo(video) {
            updateStatus("Menyiapkan A-Frame video...");
            
            const aScene = document.querySelector('a-scene');
            const videosphere = document.getElementById('videosphere');
            const assetsVideo = document.getElementById('video360');
            
            // Replace the source of assets video
            if (assetsVideo) {
                // Clone YouTube video properties to A-Frame video
                assetsVideo.src = video.src;
                assetsVideo.muted = true;
                assetsVideo.loop = true;
                assetsVideo.playsInline = true;
                
                updateStatus("Video source diterapkan ke A-Frame");
                
                // Tunggu A-Frame siap
                if (aScene.hasLoaded) {
                    startVideoPlayback();
                } else {
                    aScene.addEventListener('loaded', startVideoPlayback);
                }
            }
        }

        function startVideoPlayback() {
            updateStatus("Memulai pemutaran video...");
            
            const assetsVideo = document.getElementById('video360');
            
            // Coba play video
            assetsVideo.play().then(() => {
                updateStatus("Video berhasil diputar!");
                isPlaying = true;
                
                // Sembunyikan loading, tampilkan controls
                document.getElementById('loading').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                
                // Play YouTube player juga (untuk audio)
                if (player && player.playVideo) {
                    player.playVideo();
                }
                
            }).catch(error => {
                debugLog("Error playing video: " + error.message);
                updateStatus("Butuh interaksi user untuk memutar video");
                
                // Tampilkan instruksi
                document.getElementById('status-text').innerHTML = 
                    "Klik tombol di bawah untuk memulai video<br><small>Browser membutuhkan interaksi user</small>";
            });
        }

        function onPlayerStateChange(event) {
            const states = ['UNSTARTED', 'ENDED', 'PLAYING', 'PAUSED', 'BUFFERING', 'CUED'];
            debugLog("YouTube state: " + states[event.data]);
            
            if (event.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
            } else if (event.data === YT.PlayerState.PAUSED) {
                isPlaying = false;
            }
        }

        function onPlayerError(event) {
            debugLog("YouTube error: " + event.data);
            updateStatus("Error YouTube: " + event.data);
        }

        // Control functions
        function togglePlay() {
            const assetsVideo = document.getElementById('video360');
            if (isPlaying) {
                assetsVideo.pause();
                if (player) player.pauseVideo();
            } else {
                assetsVideo.play();
                if (player) player.playVideo();
            }
            isPlaying = !isPlaying;
        }

        function toggleMute() {
            const assetsVideo = document.getElementById('video360');
            assetsVideo.muted = !assetsVideo.muted;
            if (player) {
                if (player.isMuted()) {
                    player.unMute();
                } else {
                    player.mute();
                }
            }
        }

        function enterVR() {
            const scene = document.querySelector('a-scene');
            if (scene.enterVR) {
                scene.enterVR();
            }
        }

        // Click anywhere to start (for autoplay policies)
        document.addEventListener('click', function() {
            const loading = document.getElementById('loading');
            if (loading.style.display !== 'none') {
                forcePlay();
            }
        });

        // Alternative: Direct video element approach
        function setupDirectVideo() {
            updateStatus("Mencoba metode direct video...");
            
            // Create video element directly
            const directVideo = document.createElement('video');
            directVideo.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0`;
            directVideo.crossOrigin = "anonymous";
            directVideo.loop = true;
            directVideo.playsInline = true;
            directVideo.muted = true;
            
            document.body.appendChild(directVideo);
            
            directVideo.play().then(() => {
                updateStatus("Direct video berhasil!");
            }).catch(e => {
                debugLog("Direct video error: " + e.message);
            });
        }
    </script>
</body>
</html>
